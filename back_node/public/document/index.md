## EPD引擎（Javascript）说明

#### 一、总体介绍

1. **目标**：提供一个统一的JS引擎（*epd_engine.js*），用于解析EPD的excel中定义规则的**JSON**格式模板。

2. **使用场景**：

   * 网页端

     > + 将*epd_engine.js*（推荐进行压缩处理）文件载入到浏览器页面中，使用ES6标准开发，因此要求使用chrome、firefox等支持ES6标准的浏览器。
     > + 上传JSON模板，初始化模板，函数：*M_initGlobalTemplateMap*
     > + 给定输入参数，JSON格式
     > + 调用引擎进行计算，函数：*M_calResultByRule*
     > + 返回结果为JSON格式

   * REST API接口

     > + 提供REST接口，模板装载后台自动处理，用户仅需要调用*M_calResultByRule*进行计算即可
     > + 另外提供了一些辅助接口以方便调用端



----

#### 二、本机自测

1. **目标**：方便用户在本机进行引擎的测试（双击打开html的方式）

2. **位置**：svn目录的 *code/front_html/epd/demo2.html* 文件

3. **局限**：由于只能赋值一个模板的JSON，因此此页面仅支持简单的单模板计算场景。换句话，如果模板中有互相调用的情况，存在*GetValueFromGL、GetValuesFromGL*方法，则不支持。此时建议使用在线的测试方式。

4. **引擎文件**：本次前后台共用相同的引擎代码（*epd_engine.js*）



----

#### 三、后台部署

后端使用 *nodejs+Express* 进行开发

###### 1、Html页面

* **访问方式**：

  > + 说明文档：http://192.168.1.147:9000/
  > + 全测试页面：http://192.168.1.147:9000/demo.html  此时要求所有能使用的文档均已经存在于服务器，此页面也作为第三方使用本引擎的样例代码。
  > + 简单测试页面（与本机自测页面功能相同）：http://192.168.1.147:9000/demo2.html
  > + 模板维护页面： http://192.168.1.147:9000/up-template.html 允许查看和上传模板文件

* **模板管理**：放置在 *public\rules* 目录，并且文件后缀名统一使用 *.json*

* **引擎文件**：与上文【本机测试】部分要求相同，也需要删除最后模块导出代码。

  

###### 2、REST接口

* **访问方式**：使用Restful方式，GET和POST两种协议，基础网址为：http://192.168.1.147:9000/

* **模板管理**：

  > + 模板由后台在启动时自动装载
  > + 需要放置在 *public\rules* 目录下
  > + 文件后缀名统一使用 *.json*
  > + 模板文件名称需要与模板名相一致，例如，对于名称为 *DN1* 的模板，其模板JSON的文件名需要为 ***DN1.json***

* **接口说明**：

  （1）**得到全部已经装载的模板名称列表**

  > 协议：GET
  >
  > 地址：http://192.168.1.147:9000/list
  >
  > 返回：JSON

  （2）**根据模板名称得到模板数据**

  > 协议：GET
  >
  > 地址：http://192.168.1.147:9000/template/:tplName
  >
  > 示例：http://192.168.1.147:9000/template/simple  得到 *simple* 模板的数据
  >
  > 返回：JSON

  （3）**简化模板内容**

  > 协议：POST
  >
  > 地址：http://192.168.1.147:9000/simplify
  >
  > 上传参数：需要使用application/json的方式将需要简化的模板JSON串上传
  >
  > 返回：简化后的模板JSON串
  >
  > 说明：由于原EPD的JSON模板中，绝大部分数据在本次引擎中都是没有作用的，因此可以使用此接口获取经过精简的本次引擎能使用的参数结构，可以将化简后的模板用于后续的计算。

  （4）**调用指定模板进行引擎计算**

  > 协议：POST
  >
  > 地址：http://192.168.1.147:9000/epd/:tplName
  >
  > 示例：http://192.168.1.147:9000/epd/simple  调用 *simple* 模板进行计算
  >
  > 上传参数：application/json 
  >
  > ```jso
  > {
  >  "Es_Angle": "30",
  >  "Es_TH": "1000",
  >  "Es_HD": "7000",
  >  "Es_SW": "800",
  >  "Es_TBS": "10",
  >  "Es_BBS": "20",
  >  "Es_PIT_L": "30",
  >  "System_lang": "CN"
  > }   // 此示例为simple模板的上传参数
  > ```
  >
  > 返回：计算结果JSON串
  >
  > 说明：tplName是计算所需使用的模板，需要确认后台已经存在此模板，并且该模板中调用的子模板也已经在后台

  

----

#### 四、综述

1. 引擎实现为避免解析epd中书写的公式，主要借助于JS的动态的特性，因此以其他语言实现需要依据语言特性处理此问题。
2. 引擎并发性问题，如果使用HTML加载js的方式，不会存在此问题，每次调用方法会重新定义上下文执行环境。如果使用后台的REST接口，由于nodejs的单线程特点，多次请求不会对上下文环境造成污染。
3. 后台吞吐量问题，由于nodejs的单线程特点，每次计算请求（非阻塞，此处读文件等IO操作不算计算请求）完成后才响应下次计算请求，如果需要较大负载的使用场景，可以依据cpu核心数量，部署多套后台，使用nginx进行均衡。



